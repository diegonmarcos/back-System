version: '3.8'

# Docker Mail Server
# VM: oci-f-micro_1 (130.110.251.193)

services:
  mail-app:
    image: docker-mailserver/docker-mailserver:latest
    container_name: mail-app
    hostname: mail
    domainname: diegonmarcos.com
    restart: unless-stopped
    ports:
      - "25:25"     # SMTP
      - "587:587"   # Submission
      - "993:993"   # IMAPS
    environment:
      # Basic configuration
      - ENABLE_SPAMASSASSIN=1
      - ENABLE_CLAMAV=0  # Disabled to save RAM
      - ENABLE_FAIL2BAN=1
      - ENABLE_POSTGREY=0

      # SSL/TLS
      - SSL_TYPE=letsencrypt
      - SSL_DOMAIN=mail.diegonmarcos.com

      # Other settings
      - ONE_DIR=1
      - ENABLE_POP3=0
      - ENABLE_IMAP=1
      - ENABLE_MANAGESIEVE=0

      # DKIM
      - ENABLE_DKIM=1
      - DKIM_SELECTOR=mail

      # Google SMTP Relay (for sending)
      - RELAY_HOST=smtp-relay.gmail.com
      - RELAY_PORT=587
      - RELAY_USER=${RELAY_USER}
      - RELAY_PASSWORD=${RELAY_PASSWORD}

      # Allow sending from any configured alias
      - PERMIT_DOCKER=connected-networks
      - OVERRIDE_HOSTNAME=mail.diegonmarcos.com

      # Logging
      - LOG_LEVEL=info

    volumes:
      - mail_data:/var/mail
      - mail_state:/var/mail-state
      - mail_logs:/var/log/mail
      - mail_config:/tmp/docker-mailserver
      - /etc/localtime:/etc/localtime:ro
      - ./letsencrypt:/etc/letsencrypt:ro
    networks:
      - mail_network
    deploy:
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 512M
    healthcheck:
      test: ["CMD", "ss", "-ltn", "|", "grep", "-q", "25"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    cap_add:
      - NET_ADMIN
      - SYS_PTRACE

networks:
  mail_network:
    name: mail_network
    driver: bridge

volumes:
  mail_data:
    name: mail_data
  mail_state:
    name: mail_state
  mail_logs:
    name: mail_logs
  mail_config:
    name: mail_config
