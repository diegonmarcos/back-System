version: '3.8'

# PhotoView Photo Gallery
# Deploy on: oci-p-flex_1 (Oracle ARM)
# Access via: https://photos.diegonmarcos.com (proxied through GCP NPM)

services:
  photoview:
    image: viktorstrate/photoview:latest
    container_name: photoview
    restart: unless-stopped
    environment:
      - PHOTOVIEW_MYSQL_URL=photoview:photoview@tcp(photoview-db:3306)/photoview
      - PHOTOVIEW_LISTEN_IP=0.0.0.0
      - PHOTOVIEW_LISTEN_PORT=80
      - PHOTOVIEW_PUBLIC_ENDPOINT=https://photos.diegonmarcos.com/
      - PHOTOVIEW_SERVE_UI=1
      - PHOTOVIEW_UI_PATH=/app/ui
      - PHOTOVIEW_FACE_RECOGNITION_MODELS_PATH=/app/data/models
      - PHOTOVIEW_MEDIA_CACHE=/home/photoview/media-cache
    ports:
      - "10.0.0.2:8080:80"  # Only accessible via WireGuard
    volumes:
      # Photos source - can be local or rclone mount
      - /tmp/s3mount/real-photos:/home/photoview/photos:ro
      # Media cache for thumbnails
      - photoview_cache:/home/photoview/media-cache
    depends_on:
      photoview-db:
        condition: service_healthy
    networks:
      - photoview_net
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:80"]
      interval: 30s
      timeout: 10s
      retries: 3

  photoview-db:
    image: mysql:8.0
    container_name: photoview-db
    restart: unless-stopped
    environment:
      - MYSQL_DATABASE=photoview
      - MYSQL_USER=photoview
      - MYSQL_PASSWORD=photoview
      - MYSQL_ROOT_PASSWORD=photoview_root
    volumes:
      - photoview_db:/var/lib/mysql
    networks:
      - photoview_net
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "photoview", "-pphotoview"]
      interval: 10s
      timeout: 5s
      retries: 5

volumes:
  photoview_db:
    driver: local
  photoview_cache:
    driver: local

networks:
  photoview_net:
    driver: bridge
