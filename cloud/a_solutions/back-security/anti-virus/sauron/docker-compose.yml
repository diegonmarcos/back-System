version: "3.8"

services:
  sauron:
    container_name: sauron
    restart: unless-stopped
    build:
      context: .
      dockerfile: Dockerfile.sauron
    volumes:
      # Watch paths (read-only for security)
      - /etc:/watch/etc:ro
      - /home:/watch/home:ro
      - /var/www:/watch/www:ro
      - /var/lib/docker/volumes:/watch/docker-volumes:ro
      # YARA rules
      - ./yara-rules:/etc/sauron/yara-rules:ro
      # Output
      - sauron-logs:/var/log/sauron
    environment:
      - RULES_DIR=/etc/sauron/yara-rules
      - WATCH_DIR=/watch
      - OUTPUT_FILE=/var/log/sauron/alerts.jsonl
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    networks:
      - security

  syslog-forwarder:
    image: balabit/syslog-ng:4.4.0
    container_name: syslog-forwarder
    restart: unless-stopped
    volumes:
      - ./config/syslog-ng.conf:/etc/syslog-ng/syslog-ng.conf:ro
      - sauron-logs:/var/log/sauron:ro
      - syslog-cache:/var/cache/syslog-ng
    environment:
      - CENTRAL_HOST=${CENTRAL_HOST:-34.55.55.234}
      - CENTRAL_PORT=${CENTRAL_PORT:-5514}
      - VM_NAME=${VM_NAME:-unknown}
    depends_on:
      - sauron
    networks:
      - security

volumes:
  sauron-logs:
  syslog-cache:

networks:
  security:
    driver: bridge
